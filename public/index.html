<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload de Arquivos - Jangadeiro Têxtil</title>
  <style>
    /* SEU CSS ORIGINAL */
    body { font-family: Arial, sans-serif; margin: 0; background-color: #f5f5f5; color: #333; }
    header { background-color: #444; padding: 15px; display: flex; justify-content: center; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    header img { height: 60px; }
    main { display: flex; justify-content: center; align-items: flex-start; padding: 40px 20px; }
    .container { max-width: 600px; width: 100%; }
    .form-box, .upload-box { border: 1px solid #ddd; border-radius: 15px; padding: 40px; text-align: center; background-color: #fff; box-shadow: 0px 4px 12px rgba(0,0,0,0.1); margin-bottom: 30px; }
    .form-box h2, .upload-box h2 { color: #c0392b; margin-top: 0; }
    .form-group { text-align: left; margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: bold; }
    .form-group input, .form-group textarea { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; font-size: 16px; }
    .form-group textarea { resize: vertical; min-height: 100px; }
    #drop_zone { border: 3px dashed #c0392b; border-radius: 15px; padding: 40px; cursor: pointer; transition: background-color 0.3s; }
    #drop_zone.dragover { background-color: #fde8e6; }
    #file_input { display: none; }
    #file_list { text-align: left; margin-top: 20px; font-style: italic; color: #555; }
    .btn-upload { margin-top: 25px; padding: 12px 25px; background-color: #c0392b; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; transition: background 0.3s, opacity 0.3s; }
    .btn-upload:hover:not(:disabled) { background-color: #a93226; }
    .btn-upload:disabled { background-color: #e5a19a; cursor: not-allowed; }
    #progress_wrapper { display: none; margin-top: 20px; }
    #progress_bar { width: 100%; background-color: #eee; border-radius: 8px; overflow: hidden; }
    #progress_fill { width: 0%; height: 24px; background-color: #27ae60; border-radius: 8px; text-align: center; line-height: 24px; color: white; font-weight: bold; transition: width 0.3s; }
    #status_text { font-weight: bold; margin-top: 10px; min-height: 20px; }
    
    /* [NOVO] Estilos para a área de resultado */
    #result_area { display: none; margin-top: 30px; padding: 20px; background-color: #f0fff4; border: 1px solid #27ae60; border-radius: 10px; text-align: left; }
    #result_area h3 { color: #27ae60; margin-top: 0; display: flex; align-items: center; }
    #result_area h3 svg { width: 24px; height: 24px; margin-right: 10px; }
    .link-container { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
    #folder_link_input { flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 5px; background-color: #fff; font-size: 14px; }
    #copy_button { padding: 8px 12px; background-color: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
    #copy_button:hover { background-color: #2980b9; }
  </style>
</head>
<body>
  <header>
    <img src="https://i.postimg.cc/15x2N2z8/Logo-Oficial.png" alt="Jangadeiro Têxtil">
  </header>
  <main>
    <div class="container">
      <div class="form-box">
        <h2>Informações do Cliente</h2>
        <div class="form-group"><label for="client_name">Marca / Sala</label><input type="text" id="client_name"></div>
        <div class="form-group"><label for="cnpj">CNPJ ou Razão Social</label><input type="text" id="cnpj"></div>
        <div class="form-group"><label for="client_info">Informações Adicionais</label><textarea id="client_info"></textarea></div>
      </div>
      <div class="upload-box">
        <div id="drop_zone">
          <h2>Arraste ou clique para selecionar os arquivos</h2>
          <p id="file_list">Nenhum arquivo selecionado</p>
          <input type="file" id="file_input" multiple>
        </div>
        <button id="upload_button" class="btn-upload" disabled>Enviar Arquivos</button>
        <div id="progress_wrapper">
          <p id="status_text"></p>
          <div id="progress_bar"><div id="progress_fill">0%</div></div>
        </div>
        
        <!-- [NOVO] Área de resultado -->
        <div id="result_area">
            <h3><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>Envio Concluído!</h3>
            <p>Os arquivos foram recebidos com sucesso. Use o link abaixo para acessá-los:</p>
            <div class="link-container">
                <input type="text" id="folder_link_input" readonly>
                <button id="copy_button">Copiar</button>
            </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    const CONCURRENCY_LIMIT = 3;
    const chunkSize = 10 * 1024 * 1024;
    const dropZone = document.getElementById('drop_zone');
    const fileInput = document.getElementById('file_input');
    const fileList = document.getElementById('file_list');
    const uploadButton = document.getElementById('upload_button');
    const clientNameInput = document.getElementById('client_name');
    const cnpjInput = document.getElementById('cnpj');
    const clientInfoInput = document.getElementById('client_info');
    const progressWrapper = document.getElementById('progress_wrapper');
    const progressFill = document.getElementById('progress_fill');
    const statusText = document.getElementById('status_text');
    const resultArea = document.getElementById('result_area'); // [NOVO]
    const folderLinkInput = document.getElementById('folder_link_input'); // [NOVO]
    const copyButton = document.getElementById('copy_button'); // [NOVO]
    
    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); fileInput.files = e.dataTransfer.files; updateFileList(); });
    fileInput.addEventListener('change', updateFileList);
    uploadButton.addEventListener('click', startUpload);
    copyButton.addEventListener('click', copyLinkToClipboard); // [NOVO]

    function updateFileList() {
      resultArea.style.display = 'none'; // [NOVO]
      progressWrapper.style.display = 'none';
      if (fileInput.files.length > 0) {
        fileList.innerHTML = Array.from(fileInput.files).map(f => `<div>- ${f.name}</div>`).join('');
        uploadButton.disabled = false;
      } else {
        fileList.textContent = 'Nenhum arquivo selecionado';
        uploadButton.disabled = true;
      }
    }

    async function startUpload() {
      const files = Array.from(fileInput.files);
      if (files.length === 0 || !clientNameInput.value.trim()) { alert('Por favor, preencha o nome do cliente e selecione ao menos um arquivo.'); return; }
      setControlsDisabled(true);
      progressWrapper.style.display = 'block';
      updateProgress(0, "Preparando upload...");
      const totalSize = files.reduce((acc, file) => acc + file.size, 0);
      let totalSent = 0;
      try {
        const prepareResponse = await fetch('/.netlify/functions/create-session', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ clientName: clientNameInput.value.trim(), cnpj: cnpjInput.value.trim(), clientInfo: clientInfoInput.value.trim(), files: files.map(f => ({ name: f.name, size: f.size, type: f.type })) }) });
        const prepareData = await prepareResponse.json();
        if (!prepareData.success) throw new Error(prepareData.message);
        let activeUploads = 0;
        let fileIndex = 0;
        let filesCompleted = 0;
        const processQueue = () => {
          while (activeUploads < CONCURRENCY_LIMIT && fileIndex < files.length) {
            activeUploads++;
            const currentIndex = fileIndex++;
            const file = files[currentIndex];
            const uploadInfo = prepareData.uploads.find(u => u.fileName === file.name);
            uploadFile(file, uploadInfo.uploadUrl, uploadInfo.size, (chunkSize) => {
              totalSent += chunkSize;
              updateProgress(totalSent / totalSize * 100, `Enviando ${filesCompleted + 1} de ${files.length}...`);
            }).then(() => {
                filesCompleted++;
                activeUploads--;
                if (filesCompleted === files.length) {
                  updateProgress(100, "Concluído!");
                  progressFill.style.backgroundColor = '#2ecc71';
                  
                  // [MODIFICADO] Exibe a nova área de resultado
                  folderLinkInput.value = prepareData.clientFolderLink;
                  resultArea.style.display = 'block';
                  setControlsDisabled(false);
                  uploadButton.disabled = true;
                  fileList.textContent = 'Envio concluído. Selecione novos arquivos para começar.';

                } else {
                  processQueue();
                }
              }).catch(err => { 
                alert(`Erro no upload: ${err.message}`); 
                setControlsDisabled(false);
              });
          }
        };
        processQueue();
      } catch (error) {
        alert(`Erro na preparação: ${error.message}`);
        setControlsDisabled(false);
      }
    }

    function uploadFile(file, uploadUrl, fileSize, onProgress) {
      return new Promise((resolve, reject) => {
        let offset = 0;
        const uploadNextChunk = async () => {
          if (fileSize === 0) return resolve();
          if (offset >= fileSize) return resolve();
          const chunk = file.slice(offset, offset + chunkSize);
          try {
            const res = await fetch(uploadUrl, { method: 'PUT', headers: { 'Content-Range': `bytes ${offset}-${offset + chunk.size - 1}/${fileSize}` }, body: chunk });
            if (!res.ok && res.status !== 308) throw new Error(`Status ${res.status}`);
            offset += chunk.size;
            if (onProgress) onProgress(chunk.size);
            uploadNextChunk();
          } catch (err) {
            reject(err);
          }
        };
        uploadNextChunk();
      });
    }

    // [NOVO] Função para o botão de copiar
    function copyLinkToClipboard() {
        folderLinkInput.select();
        document.execCommand("copy");
        copyButton.textContent = 'Copiado!';
        setTimeout(() => { copyButton.textContent = 'Copiar'; }, 2000);
    }
    
    function updateProgress(percent, text) {
        const p = Math.min(100, Math.round(percent));
        progressFill.style.width = `${p}%`;
        progressFill.textContent = `${p}%`;
        if (text) statusText.textContent = text;
    }
    
    function setControlsDisabled(disabled) {
        fileInput.disabled = disabled;
        uploadButton.disabled = disabled;
        clientNameInput.disabled = disabled;
        cnpjInput.disabled = disabled;
        clientInfoInput.disabled = disabled;
        dropZone.style.pointerEvents = disabled ? 'none' : 'auto';
        dropZone.style.opacity = disabled ? 0.6 : 1;
    }
  </script>
</body>
</html>




